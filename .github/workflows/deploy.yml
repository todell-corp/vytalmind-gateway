name: Deploy VytalMind Gateway

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - standalone

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  validate:
    name: Validate Configuration
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose files
        run: |
          docker compose config > /dev/null
          echo "‚úÖ docker-compose.yml is valid"

      - name: Validate docker-compose.shared.yml
        run: |
          docker compose -f docker-compose.yml -f docker-compose.shared.yml config > /dev/null
          echo "‚úÖ docker-compose.shared.yml is valid"

      - name: Check required scripts exist
        run: |
          test -f scripts/setup.sh || (echo "‚ùå scripts/setup.sh not found" && exit 1)
          test -f scripts/health-check.sh || (echo "‚ùå scripts/health-check.sh not found" && exit 1)
          test -f scripts/teardown.sh || (echo "‚ùå scripts/teardown.sh not found" && exit 1)
          echo "‚úÖ All required scripts exist"

      - name: Validate Envoy configuration files exist
        run: |
          test -f edge/envoy.yaml || (echo "‚ùå edge/envoy.yaml not found" && exit 1)
          test -f internal/envoy.yaml || (echo "‚ùå internal/envoy.yaml not found" && exit 1)
          echo "‚úÖ Envoy configuration files exist"

  build:
    name: Build Images
    runs-on: self-hosted
    needs: validate
    strategy:
      matrix:
        component: [edge, internal]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.component }} image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          file: ./${{ matrix.component }}/Dockerfile
          push: false
          tags: vytalmind-gateway-${{ matrix.component }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/${{ matrix.component }}-image.tar

      - name: Upload ${{ matrix.component }} image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component }}-image
          path: /tmp/${{ matrix.component }}-image.tar
          retention-days: 1

  deploy:
    name: Deploy Gateway
    runs-on: self-hosted
    needs: build
    environment:
      name: development
      url: https://gateway.vytalmind.local
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download edge image
        uses: actions/download-artifact@v4
        with:
          name: edge-image
          path: /tmp

      - name: Download internal image
        uses: actions/download-artifact@v4
        with:
          name: internal-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/edge-image.tar
          docker load --input /tmp/internal-image.tar

      - name: Configure deployment environment
        run: |
          cp .env.example .env

          # Set Vault credentials from secrets
          sed -i "s|EDGE_VAULT_ROLE_ID=.*|EDGE_VAULT_ROLE_ID=${{ secrets.EDGE_VAULT_ROLE_ID }}|" .env
          sed -i "s|EDGE_VAULT_SECRET_ID=.*|EDGE_VAULT_SECRET_ID=${{ secrets.EDGE_VAULT_SECRET_ID }}|" .env
          sed -i "s|INTERNAL_VAULT_ROLE_ID=.*|INTERNAL_VAULT_ROLE_ID=${{ secrets.INTERNAL_VAULT_ROLE_ID }}|" .env
          sed -i "s|INTERNAL_VAULT_SECRET_ID=.*|INTERNAL_VAULT_SECRET_ID=${{ secrets.INTERNAL_VAULT_SECRET_ID }}|" .env

          # Set Keycloak configuration
          sed -i "s|KEYCLOAK_URL=.*|KEYCLOAK_URL=${{ secrets.KEYCLOAK_URL }}|" .env
          sed -i "s|KEYCLOAK_CLIENT_SECRET=.*|KEYCLOAK_CLIENT_SECRET=${{ secrets.KEYCLOAK_CLIENT_SECRET }}|" .env

          # Set deployment mode
          sed -i "s|DEPLOYMENT_MODE=.*|DEPLOYMENT_MODE=${{ github.event.inputs.mode || 'production' }}|" .env

      - name: Check existing deployment
        run: |
          echo "üîç Checking for existing deployment..."
          if docker compose ps -q | grep -q .; then
            echo "‚ö†Ô∏è Existing deployment found - will perform rolling update"
            docker compose ps
          else
            echo "‚úÖ No existing deployment - will perform fresh deployment"
          fi

      - name: Deploy services
        run: |
          echo "üöÄ Deploying gateway services..."

          if [ "${{ github.event.inputs.mode }}" = "standalone" ]; then
            # Standalone mode: use docker-compose.shared.yml
            docker compose -f docker-compose.yml -f docker-compose.shared.yml up -d --build --remove-orphans
          else
            # Production mode: use main docker-compose.yml
            docker compose up -d --build --remove-orphans
          fi

          echo "‚úÖ Services deployment initiated"
          docker compose ps

      - name: Wait for services to be healthy
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 30

          max_attempts=12
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if make health 2>&1 | grep -q "‚úÖ"; then
              echo "‚úÖ All services are healthy"
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - Services not ready yet..."
            sleep 10
          done

          echo "‚ùå Services failed to become healthy"
          docker compose logs
          exit 1

      - name: Run smoke tests
        run: |
          # Test Edge Envoy admin endpoint
          curl -f http://localhost:9901/ready || (echo "‚ùå Edge Envoy not ready" && exit 1)
          echo "‚úÖ Edge Envoy is ready"

          # Test Internal Envoy admin endpoint
          curl -f http://localhost:9902/ready || (echo "‚ùå Internal Envoy not ready" && exit 1)
          echo "‚úÖ Internal Envoy is ready"

          # Test Redis
          docker exec redis redis-cli ping || (echo "‚ùå Redis not responding" && exit 1)
          echo "‚úÖ Redis is responding"

      - name: Collect deployment logs
        if: always()
        run: |
          mkdir -p deployment-logs
          docker compose logs > deployment-logs/all-services.log
          docker compose logs edge-envoy > deployment-logs/edge-envoy.log
          docker compose logs internal-envoy > deployment-logs/internal-envoy.log
          docker compose logs edge-vault-agent > deployment-logs/edge-vault-agent.log
          docker compose logs internal-vault-agent > deployment-logs/internal-vault-agent.log
          docker compose logs redis > deployment-logs/redis.log

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_number }}
          path: deployment-logs/
          retention-days: 30

      - name: Post-deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Gateway deployment successful!"
          else
            echo "‚ùå Gateway deployment failed!"
          fi
