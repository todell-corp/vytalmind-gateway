name: Deploy VytalMind Gateway

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    name: Build and Deploy Gateway
    runs-on: self-hosted
    environment:
      name: development
      url: https://gateway.vytalmind.local
    steps:
      - name: Validate required secrets
        run: |
          test -n "${{ secrets.EDGE_VAULT_ROLE_ID }}" || (echo "‚ùå EDGE_VAULT_ROLE_ID not set" && exit 1)
          test -n "${{ secrets.EDGE_VAULT_SECRET_ID }}" || (echo "‚ùå EDGE_VAULT_SECRET_ID not set" && exit 1)
          test -n "${{ secrets.INTERNAL_VAULT_ROLE_ID }}" || (echo "‚ùå INTERNAL_VAULT_ROLE_ID not set" && exit 1)
          test -n "${{ secrets.INTERNAL_VAULT_SECRET_ID }}" || (echo "‚ùå INTERNAL_VAULT_SECRET_ID not set" && exit 1)
          test -n "${{ secrets.OAUTH2_CLIENT_SECRET }}" || (echo "‚ùå OAUTH2_CLIENT_SECRET not set" && exit 1)
          test -n "${{ secrets.OAUTH2_HMAC_SECRET }}" || (echo "‚ùå OAUTH2_HMAC_SECRET not set" && exit 1)
          echo "‚úÖ All required secrets are configured"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose files
        run: |
          docker compose config > /dev/null
          echo "‚úÖ docker-compose.yml is valid"

          docker compose -f docker-compose.yml -f docker-compose.shared.yml config > /dev/null
          echo "‚úÖ docker-compose.shared.yml is valid"

      - name: Check required files
        run: |
          test -f scripts/setup.sh || (echo "‚ùå scripts/setup.sh not found" && exit 1)
          test -f scripts/health-check.sh || (echo "‚ùå scripts/health-check.sh not found" && exit 1)
          test -f scripts/teardown.sh || (echo "‚ùå scripts/teardown.sh not found" && exit 1)
          test -f edge/envoy.yaml || (echo "‚ùå edge/envoy.yaml not found" && exit 1)
          test -f internal/envoy.yaml || (echo "‚ùå internal/envoy.yaml not found" && exit 1)
          echo "‚úÖ All required files exist"

      - name: Generate OAuth2 secret files
        env:
          OAUTH2_CLIENT_SECRET: ${{ secrets.OAUTH2_CLIENT_SECRET }}
          OAUTH2_HMAC_SECRET: ${{ secrets.OAUTH2_HMAC_SECRET }}
        run: |
          echo "üîê Generating OAuth2 secret files from templates..."

          # Generate token_secret.yaml from template using awk (handles special chars safely)
          awk -v secret="$OAUTH2_CLIENT_SECRET" \
            '{gsub(/OAUTH2_CLIENT_SECRET_PLACEHOLDER/, secret); print}' \
            internal/config/token_secret.yaml.template > internal/config/token_secret.yaml

          # Generate hmac_secret.yaml from template using awk (handles special chars safely)
          awk -v secret="$OAUTH2_HMAC_SECRET" \
            '{gsub(/OAUTH2_HMAC_SECRET_PLACEHOLDER/, secret); print}' \
            internal/config/hmac_secret.yaml.template > internal/config/hmac_secret.yaml

          # Set restrictive permissions
          chmod 600 internal/config/token_secret.yaml
          chmod 600 internal/config/hmac_secret.yaml

          echo "‚úÖ OAuth2 secret files generated"

      - name: Check existing deployment
        run: |
          echo "üîç Checking for existing deployment..."
          if docker compose ps -q | grep -q .; then
            echo "‚ö†Ô∏è Existing deployment found - will perform rolling update"
            docker compose ps
          else
            echo "‚úÖ No existing deployment - will perform fresh deployment"
          fi

      - name: Start Vault agents first
        env:
          VAULT_ADDR: https://vault.odell.com:8200
          EDGE_VAULT_ROLE_ID: ${{ secrets.EDGE_VAULT_ROLE_ID }}
          EDGE_VAULT_SECRET_ID: ${{ secrets.EDGE_VAULT_SECRET_ID }}
          INTERNAL_VAULT_ROLE_ID: ${{ secrets.INTERNAL_VAULT_ROLE_ID }}
          INTERNAL_VAULT_SECRET_ID: ${{ secrets.INTERNAL_VAULT_SECRET_ID }}
        run: |
          echo "üîë Starting Vault agents to generate certificates..."
          docker compose up -d --build edge-vault-agent internal-vault-agent

          echo "‚è≥ Waiting for certificates to be generated..."
          sleep 15

          echo "‚úÖ Vault agents started and certificates generated"

      - name: Start Envoy and remaining services
        env:
          VAULT_ADDR: https://vault.odell.com:8200
          EDGE_VAULT_ROLE_ID: ${{ secrets.EDGE_VAULT_ROLE_ID }}
          EDGE_VAULT_SECRET_ID: ${{ secrets.EDGE_VAULT_SECRET_ID }}
          INTERNAL_VAULT_ROLE_ID: ${{ secrets.INTERNAL_VAULT_ROLE_ID }}
          INTERNAL_VAULT_SECRET_ID: ${{ secrets.INTERNAL_VAULT_SECRET_ID }}
          KEYCLOAK_URL: ${{ secrets.KEYCLOAK_URL }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
        run: |
          echo "üöÄ Starting Envoy gateway services..."
          docker compose up -d --build edge-envoy internal-envoy

          echo "üèóÔ∏è Starting remaining services..."
          docker compose up -d --build --remove-orphans

          echo "‚úÖ All services deployed"
          docker compose ps

      - name: Wait for services to be healthy
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 30

          max_attempts=12
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if make health 2>&1 | grep -q "‚úÖ"; then
              echo "‚úÖ All services are healthy"
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - Services not ready yet..."
            sleep 10
          done

          echo "‚ùå Services failed to become healthy"
          docker compose logs
          exit 1

      - name: Run smoke tests
        run: |
          # Test Edge Envoy admin endpoint
          curl -f http://localhost:9901/ready || (echo "‚ùå Edge Envoy not ready" && exit 1)
          echo "‚úÖ Edge Envoy is ready"

          # Test Internal Envoy admin endpoint
          curl -f http://localhost:9902/ready || (echo "‚ùå Internal Envoy not ready" && exit 1)
          echo "‚úÖ Internal Envoy is ready"

          # Test Redis
          docker exec redis redis-cli ping || (echo "‚ùå Redis not responding" && exit 1)
          echo "‚úÖ Redis is responding"

      - name: Cleanup OAuth2 secret files
        if: always()
        run: |
          # Remove generated secret files to prevent leakage in workspace
          rm -f internal/config/token_secret.yaml
          rm -f internal/config/hmac_secret.yaml
          echo "üßπ Secret files cleaned up"

      - name: Post-deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Gateway deployment successful!"
          else
            echo "‚ùå Gateway deployment failed!"
            echo "üìã Collecting logs for troubleshooting..."
            docker compose logs --tail=100
          fi
