name: Health Check

on:
  schedule:
    # Run health checks every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Run Health Checks
    runs-on: self-hosted
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "ENV_NAME=development" >> $GITHUB_ENV
          echo "EDGE_ADMIN_URL=http://localhost:9901" >> $GITHUB_ENV
          echo "INTERNAL_ADMIN_URL=http://localhost:9902" >> $GITHUB_ENV

      - name: Check Edge Envoy health
        id: edge-health
        continue-on-error: true
        run: |
          echo "üîç Checking Edge Envoy health..."

          # Check ready endpoint
          if curl -f -s ${{ env.EDGE_ADMIN_URL }}/ready > /dev/null; then
            echo "‚úÖ Edge Envoy is ready"
          else
            echo "‚ùå Edge Envoy is not ready"
            echo "edge_healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check server info
          curl -s ${{ env.EDGE_ADMIN_URL }}/server_info | jq '.'

          # Check cluster health
          echo "üìä Edge Envoy cluster status:"
          curl -s ${{ env.EDGE_ADMIN_URL }}/clusters | grep -E "health_flags|priority"

          echo "edge_healthy=true" >> $GITHUB_OUTPUT

      - name: Check Internal Envoy health
        id: internal-health
        continue-on-error: true
        run: |
          echo "üîç Checking Internal Envoy health..."

          # Check ready endpoint
          if curl -f -s ${{ env.INTERNAL_ADMIN_URL }}/ready > /dev/null; then
            echo "‚úÖ Internal Envoy is ready"
          else
            echo "‚ùå Internal Envoy is not ready"
            echo "internal_healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check server info
          curl -s ${{ env.INTERNAL_ADMIN_URL }}/server_info | jq '.'

          # Check cluster health
          echo "üìä Internal Envoy cluster status:"
          curl -s ${{ env.INTERNAL_ADMIN_URL }}/clusters | grep -E "health_flags|priority"

          echo "internal_healthy=true" >> $GITHUB_OUTPUT

      - name: Check Redis health
        id: redis-health
        continue-on-error: true
        run: |
          echo "üîç Checking Redis health..."

          if docker exec redis redis-cli ping | grep -q "PONG"; then
            echo "‚úÖ Redis is healthy"
            echo "redis_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Redis is not healthy"
            echo "redis_healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check Redis info
          docker exec redis redis-cli info server | grep -E "redis_version|uptime_in_seconds"
          docker exec redis redis-cli info stats | grep -E "total_connections_received|total_commands_processed"

      - name: Check certificate expiration
        id: cert-check
        continue-on-error: true
        run: |
          echo "ÔøΩÔøΩ Checking certificate expiration..."

          # Check Edge TLS certificate
          echo "Edge TLS Certificate:"
          docker exec edge-envoy openssl x509 -noout -enddate -in /etc/envoy/certs/edge/server.crt

          edge_days=$(docker exec edge-envoy openssl x509 -noout -enddate -in /etc/envoy/certs/edge/server.crt | sed 's/notAfter=//' | xargs -I {} date -d {} +%s)
          current_days=$(date +%s)
          days_until_edge_expiry=$(( ($edge_days - $current_days) / 86400 ))

          echo "edge_days_remaining=$days_until_edge_expiry" >> $GITHUB_OUTPUT

          if [ $days_until_edge_expiry -lt 7 ]; then
            echo "‚ö†Ô∏è Edge certificate expires in $days_until_edge_expiry days"
            echo "edge_cert_warning=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Edge certificate expires in $days_until_edge_expiry days"
            echo "edge_cert_warning=false" >> $GITHUB_OUTPUT
          fi

          # Check Internal mTLS certificate
          echo "Internal mTLS Certificate:"
          docker exec internal-envoy openssl x509 -noout -enddate -in /etc/envoy/certs/internal/server.crt

          internal_days=$(docker exec internal-envoy openssl x509 -noout -enddate -in /etc/envoy/certs/internal/server.crt | sed 's/notAfter=//' | xargs -I {} date -d {} +%s)
          days_until_internal_expiry=$(( ($internal_days - $current_days) / 86400 ))

          echo "internal_days_remaining=$days_until_internal_expiry" >> $GITHUB_OUTPUT

          if [ $days_until_internal_expiry -lt 7 ]; then
            echo "‚ö†Ô∏è Internal certificate expires in $days_until_internal_expiry days"
            echo "internal_cert_warning=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Internal certificate expires in $days_until_internal_expiry days"
            echo "internal_cert_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Check metrics availability
        id: metrics-check
        continue-on-error: true
        run: |
          echo "üìä Checking metrics endpoints..."

          # Check Edge Envoy metrics
          if curl -f -s ${{ env.EDGE_ADMIN_URL }}/stats/prometheus > /dev/null; then
            echo "‚úÖ Edge Envoy metrics available"
            edge_metrics_count=$(curl -s ${{ env.EDGE_ADMIN_URL }}/stats/prometheus | wc -l)
            echo "Edge metrics count: $edge_metrics_count"
            echo "edge_metrics_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Edge Envoy metrics not available"
            echo "edge_metrics_healthy=false" >> $GITHUB_OUTPUT
          fi

          # Check Internal Envoy metrics
          if curl -f -s ${{ env.INTERNAL_ADMIN_URL }}/stats/prometheus > /dev/null; then
            echo "‚úÖ Internal Envoy metrics available"
            internal_metrics_count=$(curl -s ${{ env.INTERNAL_ADMIN_URL }}/stats/prometheus | wc -l)
            echo "Internal metrics count: $internal_metrics_count"
            echo "internal_metrics_healthy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Internal Envoy metrics not available"
            echo "internal_metrics_healthy=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate health report
        if: always()
        run: |
          echo "# Health Check Report - ${{ env.ENV_NAME }}" > health-report.md
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> health-report.md
          echo "" >> health-report.md

          echo "## Service Health" >> health-report.md
          echo "| Service | Status |" >> health-report.md
          echo "|---------|--------|" >> health-report.md

          if [ "${{ steps.edge-health.outputs.edge_healthy }}" = "true" ]; then
            echo "| Edge Envoy | ‚úÖ Healthy |" >> health-report.md
          else
            echo "| Edge Envoy | ‚ùå Unhealthy |" >> health-report.md
          fi

          if [ "${{ steps.internal-health.outputs.internal_healthy }}" = "true" ]; then
            echo "| Internal Envoy | ‚úÖ Healthy |" >> health-report.md
          else
            echo "| Internal Envoy | ‚ùå Unhealthy |" >> health-report.md
          fi

          if [ "${{ steps.redis-health.outputs.redis_healthy }}" = "true" ]; then
            echo "| Redis | ‚úÖ Healthy |" >> health-report.md
          else
            echo "| Redis | ‚ùå Unhealthy |" >> health-report.md
          fi

          echo "" >> health-report.md
          echo "## Certificate Status" >> health-report.md
          echo "| Certificate | Days Remaining | Status |" >> health-report.md
          echo "|-------------|----------------|--------|" >> health-report.md

          if [ -n "${{ steps.cert-check.outputs.edge_days_remaining }}" ]; then
            if [ "${{ steps.cert-check.outputs.edge_cert_warning }}" = "true" ]; then
              echo "| Edge TLS | ${{ steps.cert-check.outputs.edge_days_remaining }} | ‚ö†Ô∏è Warning |" >> health-report.md
            else
              echo "| Edge TLS | ${{ steps.cert-check.outputs.edge_days_remaining }} | ‚úÖ Good |" >> health-report.md
            fi
          fi

          if [ -n "${{ steps.cert-check.outputs.internal_days_remaining }}" ]; then
            if [ "${{ steps.cert-check.outputs.internal_cert_warning }}" = "true" ]; then
              echo "| Internal mTLS | ${{ steps.cert-check.outputs.internal_days_remaining }} | ‚ö†Ô∏è Warning |" >> health-report.md
            else
              echo "| Internal mTLS | ${{ steps.cert-check.outputs.internal_days_remaining }} | ‚úÖ Good |" >> health-report.md
            fi
          fi

          echo "" >> health-report.md
          echo "## Metrics" >> health-report.md
          echo "| Endpoint | Status |" >> health-report.md
          echo "|----------|--------|" >> health-report.md

          if [ "${{ steps.metrics-check.outputs.edge_metrics_healthy }}" = "true" ]; then
            echo "| Edge Envoy Prometheus | ‚úÖ Available |" >> health-report.md
          else
            echo "| Edge Envoy Prometheus | ‚ùå Unavailable |" >> health-report.md
          fi

          if [ "${{ steps.metrics-check.outputs.internal_metrics_healthy }}" = "true" ]; then
            echo "| Internal Envoy Prometheus | ‚úÖ Available |" >> health-report.md
          else
            echo "| Internal Envoy Prometheus | ‚ùå Unavailable |" >> health-report.md
          fi

          cat health-report.md

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ env.ENV_NAME }}-${{ github.run_number }}
          path: health-report.md
          retention-days: 30

      - name: Check if alerts needed
        if: always()
        run: |
          alert_needed=false

          if [ "${{ steps.edge-health.outputs.edge_healthy }}" != "true" ]; then
            echo "‚ö†Ô∏è ALERT: Edge Envoy is unhealthy"
            alert_needed=true
          fi

          if [ "${{ steps.internal-health.outputs.internal_healthy }}" != "true" ]; then
            echo "‚ö†Ô∏è ALERT: Internal Envoy is unhealthy"
            alert_needed=true
          fi

          if [ "${{ steps.redis-health.outputs.redis_healthy }}" != "true" ]; then
            echo "‚ö†Ô∏è ALERT: Redis is unhealthy"
            alert_needed=true
          fi

          if [ "${{ steps.cert-check.outputs.edge_cert_warning }}" = "true" ]; then
            echo "‚ö†Ô∏è ALERT: Edge certificate expiring soon"
            alert_needed=true
          fi

          if [ "${{ steps.cert-check.outputs.internal_cert_warning }}" = "true" ]; then
            echo "‚ö†Ô∏è ALERT: Internal certificate expiring soon"
            alert_needed=true
          fi

          if [ "$alert_needed" = "true" ]; then
            echo "üö® Health check failed - immediate attention required"
            exit 1
          else
            echo "‚úÖ All health checks passed"
          fi
