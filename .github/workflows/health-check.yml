name: Health Check

on:
  schedule:
    # Run health checks every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Run Health Checks
    runs-on: self-hosted
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Envoy health
        id: envoy-health
        continue-on-error: true
        run: |
          echo "üîç Checking Envoy health..."

          # Check ready endpoint
          if curl -f -s http://localhost:9901/ready > /dev/null; then
            echo "‚úÖ Envoy is ready"
          else
            echo "‚ùå Envoy is not ready"
            echo "envoy_healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check server info
          curl -s http://localhost:9901/server_info | jq '.'

          echo "envoy_healthy=true" >> $GITHUB_OUTPUT

      - name: Check certificate expiration
        id: cert-check
        continue-on-error: true
        run: |
          echo "üîí Checking certificate expiration..."

          # Check TLS certificate
          docker exec envoy openssl x509 -noout -enddate -in /etc/envoy/certs/tls-server.crt

          cert_days=$(docker exec envoy openssl x509 -noout -enddate -in /etc/envoy/certs/tls-server.crt | sed 's/notAfter=//' | xargs -I {} date -d {} +%s)
          current_days=$(date +%s)
          days_until_expiry=$(( ($cert_days - $current_days) / 86400 ))

          echo "days_remaining=$days_until_expiry" >> $GITHUB_OUTPUT

          if [ $days_until_expiry -lt 7 ]; then
            echo "‚ö†Ô∏è Certificate expires in $days_until_expiry days"
            echo "cert_warning=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Certificate expires in $days_until_expiry days"
            echo "cert_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Test health endpoint
        id: health-endpoint
        continue-on-error: true
        run: |
          echo "üè• Testing health endpoint..."

          if curl -fk https://localhost:443/health > /dev/null 2>&1; then
            echo "‚úÖ Health endpoint responding"
            echo "health_endpoint_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Health endpoint not responding"
            echo "health_endpoint_ok=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate health report
        if: always()
        run: |
          echo "# Health Check Report" > health-report.md
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> health-report.md
          echo "" >> health-report.md

          echo "## Service Health" >> health-report.md
          echo "| Service | Status |" >> health-report.md
          echo "|---------|--------|" >> health-report.md

          if [ "${{ steps.envoy-health.outputs.envoy_healthy }}" = "true" ]; then
            echo "| Envoy | ‚úÖ Healthy |" >> health-report.md
          else
            echo "| Envoy | ‚ùå Unhealthy |" >> health-report.md
          fi

          echo "" >> health-report.md
          echo "## Certificate Status" >> health-report.md
          echo "| Certificate | Days Remaining | Status |" >> health-report.md
          echo "|-------------|----------------|--------|" >> health-report.md

          if [ -n "${{ steps.cert-check.outputs.days_remaining }}" ]; then
            if [ "${{ steps.cert-check.outputs.cert_warning }}" = "true" ]; then
              echo "| TLS Server | ${{ steps.cert-check.outputs.days_remaining }} | ‚ö†Ô∏è Warning |" >> health-report.md
            else
              echo "| TLS Server | ${{ steps.cert-check.outputs.days_remaining }} | ‚úÖ Good |" >> health-report.md
            fi
          fi

          echo "" >> health-report.md
          echo "## Endpoints" >> health-report.md
          echo "| Endpoint | Status |" >> health-report.md
          echo "|----------|--------|" >> health-report.md

          if [ "${{ steps.health-endpoint.outputs.health_endpoint_ok }}" = "true" ]; then
            echo "| /health | ‚úÖ Responding |" >> health-report.md
          else
            echo "| /health | ‚ùå Not responding |" >> health-report.md
          fi

          cat health-report.md

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: health-report.md
          retention-days: 30

      - name: Check if alerts needed
        if: always()
        run: |
          alert_needed=false

          if [ "${{ steps.envoy-health.outputs.envoy_healthy }}" != "true" ]; then
            echo "‚ö†Ô∏è ALERT: Envoy is unhealthy"
            alert_needed=true
          fi

          if [ "${{ steps.cert-check.outputs.cert_warning }}" = "true" ]; then
            echo "‚ö†Ô∏è ALERT: Certificate expiring soon"
            alert_needed=true
          fi

          if [ "${{ steps.health-endpoint.outputs.health_endpoint_ok }}" != "true" ]; then
            echo "‚ö†Ô∏è ALERT: Health endpoint not responding"
            alert_needed=true
          fi

          if [ "$alert_needed" = "true" ]; then
            echo "üö® Health check failed - immediate attention required"
            exit 1
          else
            echo "‚úÖ All health checks passed"
          fi
