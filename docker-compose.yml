version: '3.8'

networks:
  edge-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  internal-network:
    driver: bridge
    internal: true  # No external access - zero trust boundary
    ipam:
      config:
        - subnet: 172.21.0.0/24
  monitoring:
    driver: bridge

volumes:
  redis-data:
  keycloak-data:

services:
  # Redis - Distributed Rate Limiting
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./infrastructure/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - edge-network
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5


  # Edge Envoy - External Gateway with TLS Termination
  edge-envoy:
    build:
      context: ./edge
      dockerfile: Dockerfile
    container_name: edge-envoy
    depends_on:
      redis:
        condition: service_healthy
      # Remove keycloak dependency if using external Keycloak
    ports:
      - "443:10000"   # HTTPS listener
      - "9901:9901"   # Admin interface
    environment:
      ENVOY_UID: 0
      VAULT_ADDR: ${VAULT_ADDR:-https://vault.odell.com:8200}
      VAULT_ROLE_ID: ${EDGE_VAULT_ROLE_ID}
      VAULT_SECRET_ID: ${EDGE_VAULT_SECRET_ID}
    volumes:
      - ./edge/envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./edge/config:/etc/envoy/config:ro
      - ./edge/certs:/etc/envoy/certs
      - ./edge/logs:/var/log/envoy
    networks:
      - edge-network
      - internal-network  # Can reach internal-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9901/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Internal Envoy - Internal Gateway
  internal-envoy:
    build:
      context: ./internal
      dockerfile: Dockerfile
    container_name: internal-envoy
    ports:
      - "9902:9901"   # Admin interface (different port)
    environment:
      ENVOY_UID: 0
      VAULT_ADDR: ${VAULT_ADDR:-https://vault.odell.com:8200}
      VAULT_ROLE_ID: ${INTERNAL_VAULT_ROLE_ID}
      VAULT_SECRET_ID: ${INTERNAL_VAULT_SECRET_ID}
    volumes:
      - ./internal/envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./internal/config:/etc/envoy/config:ro
      - ./internal/certs:/etc/envoy/certs
      - ./internal/logs:/var/log/envoy
    networks:
      - internal-network  # Only internal network - zero trust
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9901/ready"]
      interval: 10s
      timeout: 5s
      retries: 5


  # Example Backend Service (without mTLS) - for direct edge routing
  backend-simple:
    image: hashicorp/http-echo
    container_name: backend-simple
    networks:
      - edge-network
    command: ["-text", "Hello from simple backend (via edge)"]

  # Example Backend Service (with mTLS) - must go through internal-envoy
  backend-secure:
    image: hashicorp/http-echo
    container_name: backend-secure
    networks:
      - internal-network
    command: ["-text", "Hello from secure backend (via internal envoy)"]
