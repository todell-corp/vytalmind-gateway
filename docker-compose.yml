version: '3.8'

volumes:
  certs:  # TLS certificates managed by vault-agent
  secrets:  # OAuth2 secrets

services:
  # Vault Agent - Manages TLS Certificates
  vault-agent:
    image: hashicorp/vault:1.16
    container_name: vault-agent
    environment:
      VAULT_ADDR: ${VAULT_ADDR:-https://vault.odell.com:8200}
      VAULT_ROLE_ID: ${VAULT_ROLE_ID}
      VAULT_SECRET_ID: ${VAULT_SECRET_ID}
      TLS_DOMAIN: ${TLS_DOMAIN:-vytalmind-api.odell.com}
      TLS_CERT_TTL: ${TLS_CERT_TTL:-168h}
    volumes:
      - certs:/vault/certs
      - ./vault/vault-agent.hcl:/vault/config/agent.hcl:ro
      - ./scripts:/vault/scripts:ro
    dns:
      - 192.168.50.160  # Custom DNS server for vault.odell.com
      - 8.8.8.8
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache jq
        echo "$${VAULT_ROLE_ID}" > /tmp/role-id
        echo "$${VAULT_SECRET_ID}" > /tmp/secret-id
        exec vault agent -config=/vault/config/agent.hcl
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/vault-token && pgrep -f 'vault agent'"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Envoy - TLS Termination Gateway
  envoy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: envoy
    depends_on:
      vault-agent:
        condition: service_healthy
    ports:
      - "443:443"    # HTTPS listener
      - "9901:9901"  # Admin interface
    environment:
      ENVOY_UID: 0
      OAUTH2_CLIENT_SECRET: ${OAUTH2_CLIENT_SECRET}
      OAUTH2_HMAC_SECRET: ${OAUTH2_HMAC_SECRET}
    volumes:
      - certs:/etc/envoy/certs:ro
      - secrets:/etc/envoy/secrets
      - ./secrets:/tmp/templates:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Generate OAuth2 secrets from environment variables
        apk add --no-cache gettext
        mkdir -p /etc/envoy/secrets
        envsubst < /tmp/templates/client-secret.yaml.template > /etc/envoy/secrets/client-secret.yaml
        envsubst < /tmp/templates/hmac-secret.yaml.template > /etc/envoy/secrets/hmac-secret.yaml
        # Start Envoy
        exec /usr/local/bin/envoy -c /etc/envoy/envoy.yaml --log-level info
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9901/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
