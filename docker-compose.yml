version: '3.8'

networks:
  edge-network:
    driver: bridge
  internal-network:
    driver: bridge
    internal: true  # No external access - zero trust boundary
  monitoring:
    driver: bridge

volumes:
  redis-data:
  keycloak-data:
  vault-certs:

services:
  # Vault Agent - Certificate Management for Edge and Internal Envoy
  vault-agent:
    image: hashicorp/vault:1.16
    container_name: vault-agent
    environment:
      VAULT_ADDR: ${VAULT_ADDR:-https://vault.odell.com:8200}
      EDGE_VAULT_ROLE_ID: ${EDGE_VAULT_ROLE_ID}
      EDGE_VAULT_SECRET_ID: ${EDGE_VAULT_SECRET_ID}
      INTERNAL_VAULT_ROLE_ID: ${INTERNAL_VAULT_ROLE_ID}
      INTERNAL_VAULT_SECRET_ID: ${INTERNAL_VAULT_SECRET_ID}
    volumes:
      - vault-certs:/vault/certs
      - ./infrastructure/vault-agent:/vault/config
    networks:
      - edge-network
      - internal-network
    entrypoint: ["/bin/sh", "/vault/config/entrypoint.sh"]
    command: agent -config=/vault/config/agent.hcl
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/vault-token && pgrep -f 'vault agent'"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Distributed Rate Limiting
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./infrastructure/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - edge-network
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5


  # Edge Envoy - External Gateway with TLS Termination
  edge-envoy:
    build:
      context: ./edge
      dockerfile: Dockerfile
    container_name: edge-envoy
    depends_on:
      redis:
        condition: service_healthy
      vault-agent:
        condition: service_healthy
      # Remove keycloak dependency if using external Keycloak
    ports:
      - "192.168.50.80:443:10000"   # HTTPS listener
      - "192.168.50.80:9901:9901"   # Admin interface
    environment:
      ENVOY_UID: 0
    volumes:
      - ./edge/envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./edge/config:/etc/envoy/config:ro
      - vault-certs:/etc/envoy/certs:ro
      - ./edge/logs:/var/log/envoy
    networks:
      - edge-network
      - internal-network  # Can reach internal-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9901/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Internal Envoy - Internal Gateway
  internal-envoy:
    build:
      context: ./internal
      dockerfile: Dockerfile
    container_name: internal-envoy
    depends_on:
      vault-agent:
        condition: service_healthy
    ports:
      - "192.168.50.122:443:443"      # HTTPS listener (SNI-based routing)
      - "192.168.50.122:9902:9901"    # Admin interface
    environment:
      ENVOY_UID: 0
    volumes:
      - ./internal/envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./internal/config:/etc/envoy/config:ro
      - vault-certs:/etc/envoy/certs:ro
      - ./internal/logs:/var/log/envoy
    networks:
      - internal-network  # Only internal network - zero trust
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9901/ready"]
      interval: 10s
      timeout: 5s
      retries: 5


  # Example Backend Service (without mTLS) - for direct edge routing
  backend-simple:
    image: hashicorp/http-echo
    container_name: backend-simple
    networks:
      - edge-network
    command: ["-text", "Hello from simple backend (via edge)"]

  # Example Backend Service (with mTLS) - must go through internal-envoy
  backend-secure:
    image: hashicorp/http-echo
    container_name: backend-secure
    networks:
      - internal-network
    command: ["-text", "Hello from secure backend (via internal envoy)"]
